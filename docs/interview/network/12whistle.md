---
title: 抓包原理以及使用whistle
order: 12
group:
  order: 2
  title: 网络
  path: /interview/network
nav:
  order: 3
  title: 'interview'
  path: /interview
---

参考：[前端人必须掌握的抓包技能](https://juejin.cn/post/7140040425129115684?searchId=20250324135617B6BC458DB0F5F131BE90)

## 抓包原理

#### HTTP 抓包原理

对于 HTTP 抓包，无需做过多的处理，只需要让中间人负责转发客户端和服务端的数据包。

#### Https 抓包原理

HTTP 是明文传输，容易受到中间人攻击，不安全。 HTTPS 语义仍然是 HTTP，只不过是在 HTTP 协议栈中 http 与 tcp 之间插入安全层 SSL/TSL。安全层采用**对称加密的方式加密传输数据**和**非对称加密的方式来传输对称密钥**，解决 http 数据没有加密、无法验证身份、数据容易纂改三个核心问题。

> Https = Http + 加密 + 完整性保护

其中验证身份问题是通过验证服务器的证书来实现的，证书是第三方组织（CA 证书签发机构）使用数字签名技术管理的，包括创建证书、存储证书、更新证书、撤销证书。

浏览器连接至一个 HTTPS 网站，服务器发送的不仅仅只是服务器实体证书，而是一个证书链，但不包含根证书，根证书会被内嵌在 Windows, Linux, macOS, Android, iOS 这些操作系统里。

在 nginx 是这样配置 https 的证书

```js
server {
    listen 443 ssl;
    server_name yourdomain.com;  // 替换为你的域名

    ssl_certificate /path/to/your/certificate.crt;  // 替换为你的 SSL 证书路径
    ssl_certificate_key /path/to/your/privatekey.key;  // 替换为你的私钥路径

    // 其他的 Nginx 配置项
    // ...
}

```

其中校验证书分为两步，证书的签发者校验和服务器实体证书校验

![证书链](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b401ce024d834d368607faba1dafc0b4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

##### 证书链校验：

1.1 浏览器从服务器实体证书的上一级证书（比如 B 证书）获取公钥，用来校验服务器实体证书的签名（签名是通过 CA 机构的私钥签名的），校验成功则继续，否则证书校验失败。

1.2 浏览器从 B 证书的上一级证书（比如 C 证书）获取公钥，用来校验 B 证书的签名，校验成功则继续，否则证书校验失败。

1.3 浏览器迭代校验每张证书的签名，最后会找到自签名的根证书（签发者和使用者是同一个人），由于浏览器已经集成了根证书，可以充分信任根证书的公钥，完成最后的签名。

##### 服务器实体证书校验：访问的域名信息是否与证书一致、日期、证书扩展校验等。

了解完证书校验后，我们来看看具体的 https 通信流程：

- 首先是 tcp 的三次握手建立连接

- 接着是非对称加密的握手过程

- 1.client 发送随机数 random1 + 支持的加密算法集合
- 2.server 收到信息，返回选择的一个加密算法+ 证书 （包含 Sercer 公钥） + random2
- 3.client 验证证书有效性，并用 random1 + random2 生成 pre-master-secure，通过服务端公钥加密发送给 server
- 4.server 收到 pre-master-secure，根据约定的算法使用 S\_私钥对 pre-master-secure 解密
- 5.这个时候，客户端和服务端都拥有 random1、random2、pre-master 以及约定的对称密钥生成方法，可以生成相同的 master-secure（对称加密的密钥）进行加解密了。

- 最后，就可以使用 master-secure 进行真正的数据对称加密传输。

中间人想要抓包，需在 HTTPS 加密通信之前：

- 截取客户端发送的包含证书的报文，伪装成服务端，把自己的证书发给客户端，然后拿到【客户端返回的包含对称加密通信密钥的报文】，生成中间人与客户端对称加密的密钥。

- 同样伪装成客户端，以服务端自己的非对称公钥加密【客户端返回的包含对称加密通信密钥的报文】发给服务端，获得服务端生成的对称加密密钥。

- 这样一来，加密通信建立完成，而中间人拿到了通信的数据密钥，可以查看、修改 HTTPS 的通信报文。

这里客户端与中间人通信、中间人与服务端通信，都是正常建立了 HTTPS 加密连接的。

其中很重要的一步是浏览器的根证书校验，CA 机构不可能随便给一个中间人签发不属于它的域名证书，也就不在客户端的操作系统上了，因此只能把中间人的根证书，导入到客户端的操作系统了，以此完成建立加密通信时对中间人证书的验证。

### 2.3 电脑如何抓手机的包

要想通过电脑端获取手机 Web 应用的数据包，根据前面所学，就需要**中间人策略**。

PC 端建立一个服务器中间人进程，伪装为 web 应用的目标服务器。手机端 web 应用发送的请求数据先经过中间人，中间人进行拦截处理再发送给目标服务器。反过来，目标服务器发送的数据包先通过中间人，再由中间人响应给浏览器客户端。这里要注意的是，无论是个人电脑 PC，还是移动端手机，都需要接入互联网网络，可以相互找到对方才能建立通信。一般对开发来说，个人电脑本地起的服务器进程，在公网上是访问不到的。一般是无线局域网，个人电脑与手机端连接同一个路由器发出的 Wi-Fi，就可以相互通信。

具体步骤：

- 在 PC 电脑本地起一个服务器进程，监听一个端口比如 8899

- 在手机上连接同一个局域网，配置网络代理，指向 PC 端的 IP 地址和 8899 端口

-这样一来，手机上所有的网络通信都会被先转发到 PC 端的 8899 端口，就可以对数据包进行分析处理

拿访问 youtuBe 来说，比如电脑已经使用【服务器软件】成功访问，此时只要手机配置代理指向电脑 ip 地址和指定端口，手机就可以同样访问 youtuBe 了。

## 抓包工具 whistle

证书里的 rootCA.pem/rootCA.cer/rootCA.crt 分别代表什么意思
